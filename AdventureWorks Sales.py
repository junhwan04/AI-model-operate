# -*- coding: utf-8 -*-
"""Untitled9.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1NZBfQttxeGW8ICOhFhLxa4sW8XWuXogb
"""

# [1] í°íŠ¸ + ë¼ì´ë¸ŒëŸ¬ë¦¬
!apt-get -qq -y install fonts-nanum

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import matplotlib.font_manager as fm
import seaborn as sns

font_path = "/usr/share/fonts/truetype/nanum/NanumGothic.ttf"
fm.fontManager.addfont(font_path)
plt.rcParams["font.family"] = "NanumGothic"
plt.rcParams["axes.unicode_minus"] = False

# [2] ì—‘ì…€ ë¶ˆëŸ¬ì˜¤ê¸° + ì „ì²˜ë¦¬
excel_path = "/content/AdventureWorks Sales (2).xlsx"

sales_order_df = pd.read_excel(excel_path, sheet_name="Sales Order_data")
sales_df       = pd.read_excel(excel_path, sheet_name="Sales_data")
customer_df    = pd.read_excel(excel_path, sheet_name="Customer_data")
date_df        = pd.read_excel(excel_path, sheet_name="Date_data")

# merge â†’ clean â†’ adventure_df ë§Œë“¤ê¸° (ì•„ê¹Œ ì¤€ ì½”ë“œ ê·¸ëŒ€ë¡œ)

# [1] í™˜ê²½ ì„¸íŒ… & í•œê¸€ í°íŠ¸
!apt-get -qq -y install fonts-nanum

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import matplotlib.font_manager as fm
import seaborn as sns

# ë‚˜ëˆ”ê³ ë”• ê²½ë¡œ
font_path = "/usr/share/fonts/truetype/nanum/NanumGothic.ttf"
fm.fontManager.addfont(font_path)

plt.rcParams["font.family"] = "NanumGothic"
plt.rcParams["axes.unicode_minus"] = False

print("âœ… ë‚˜ëˆ”ê³ ë”• í°íŠ¸ ì ìš© ì™„ë£Œ!")

# [2] ì—‘ì…€ ë¶ˆëŸ¬ì˜¤ê¸° & ì‹œíŠ¸ ëª©ë¡ í™•ì¸

excel_path = "/content/AdventureWorks Sales (2).xlsx"  # ğŸ” ì—¬ê¸° íŒŒì¼ ì´ë¦„ ë„¤ ê±°ë‘ ë§ì¶°ì¤˜!

xls = pd.ExcelFile(excel_path)
print("ğŸ“„ ì‹œíŠ¸ ëª©ë¡:", xls.sheet_names)

# [3] ê° ì‹œíŠ¸ë³„ DataFrame ë§Œë“¤ê¸°

sales_order_df = pd.read_excel(excel_path, sheet_name="Sales Order_data")
sales_df       = pd.read_excel(excel_path, sheet_name="Sales_data")
customer_df    = pd.read_excel(excel_path, sheet_name="Customer_data")
date_df        = pd.read_excel(excel_path, sheet_name="Date_data")

print("âœ… Sales_data:", sales_df.shape)
print("âœ… Sales Order_data:", sales_order_df.shape)
print("âœ… Customer_data:", customer_df.shape)
print("âœ… Date_data:", date_df.shape)

display(sales_df.head())
display(sales_order_df.head())
display(customer_df.head())
display(date_df.head())

# [4-1] Sales_data + Sales Order_data ë³‘í•©
# ê³µí†µ í‚¤: SalesOrderLineKey

merged_df = pd.merge(
    sales_df,
    sales_order_df[["SalesOrderLineKey", "Channel", "Sales Order", "Sales Order Line"]],
    on="SalesOrderLineKey",
    how="left"
)

print("ğŸ”— 1ì°¨ ë³‘í•©:", merged_df.shape)
display(merged_df.head())

# [4-2] Customer_data ë¶™ì´ê¸°
# ê³µí†µ í‚¤: CustomerKey

merged_df = pd.merge(
    merged_df,
    customer_df,
    on="CustomerKey",
    how="left"
)

print("ğŸ”— 2ì°¨ ë³‘í•© (Customer í¬í•¨):", merged_df.shape)
display(merged_df.head())



# [4-3] Date_data ë¶™ì´ê¸° (OrderDateKey -> ì‹¤ì œ ë‚ ì§œ)

merged_df = pd.merge(
    merged_df,
    date_df[["DateKey", "Date", "MonthKey"]],
    left_on="OrderDateKey",
    right_on="DateKey",
    how="left"
)

print("ğŸ”— 3ì°¨ ë³‘í•© (ë‚ ì§œ í¬í•¨):", merged_df.shape)
display(merged_df[["OrderDateKey", "Date", "MonthKey"]].head())

print("ğŸ“„ date_df ì»¬ëŸ¼ëª…:", date_df.columns.tolist())
print("ğŸ“„ merged_df ì»¬ëŸ¼ëª…:", merged_df.columns.tolist())

# [4-3] Date_data ë¶™ì´ê¸° (OrderDateKey -> ì‹¤ì œ ë‚ ì§œ)

merged_df = pd.merge(
    merged_df,
    date_df[["DateKey", "Date", "MonthKey"]],
    left_on="OrderDateKey",
    right_on="DateKey",
    how="left"
)

# ğŸ‘‰ y ìª½(ì´ë²ˆì— ë¶™ì¸) ë‚ ì§œ/ì›” ì»¬ëŸ¼ì„ ì •ì‹ ì´ë¦„ìœ¼ë¡œ ì‚¬ìš©
merged_df = merged_df.rename(columns={
    "Date_y": "Date",
    "MonthKey_y": "MonthKey"
})

# ğŸ‘‰ ë” ì´ìƒ í•„ìš” ì—†ëŠ” xìª½/í‚¤ ì»¬ëŸ¼ì€ ì •ë¦¬
merged_df = merged_df.drop(columns=[
    "Date_x", "MonthKey_x", "DateKey_x", "DateKey_y"
], errors="ignore")

print("ğŸ”— 3ì°¨ ë³‘í•© (ë‚ ì§œ í¬í•¨):", merged_df.shape)
display(merged_df[["OrderDateKey", "Date", "MonthKey"]].head())

# [4-4] "[Not Applicable]" ê³ ê° ì œê±° + í•µì‹¬ ì»¬ëŸ¼ë§Œ ì •ë¦¬

clean_df = merged_df[merged_df["Customer"] != "[Not Applicable]"].copy()

adventure_df = clean_df[[
    "SalesOrderLineKey",
    "Sales Order",
    "Channel",
    "CustomerKey",
    "Customer",
    "City",
    "State-Province",
    "Country-Region",
    "OrderDateKey",
    "Date",        # ì‹¤ì œ ë‚ ì§œ
    "MonthKey",
    "ProductKey",
    "Order Quantity",
    "Unit Price",
    "Sales Amount"
]].copy()

# ì»¬ëŸ¼ëª… ì¡°ê¸ˆ ì˜ˆì˜ê²Œ
adventure_df = adventure_df.rename(columns={
    "Sales Order": "SalesOrderID",
    "State-Province": "StateProvince",
    "Country-Region": "CountryRegion",
    "Order Quantity": "OrderQuantity",
    "Unit Price": "UnitPrice",
    "Sales Amount": "SalesAmount",
    "Date": "OrderDate"
})

adventure_df.info()
display(adventure_df.head())

# [4-5] íƒ€ì… ë³€í™˜ + YearMonth íŒŒìƒ ì»¬ëŸ¼ ì •ë¦¬

# 0ï¸âƒ£ í˜¹ì‹œ ëª¨ë¥¼ ì¤‘ë³µ ì»¬ëŸ¼ ì œê±°
dup_cols = adventure_df.columns[adventure_df.columns.duplicated()].tolist()
print("âš ï¸ ì¤‘ë³µ ì»¬ëŸ¼:", dup_cols)
adventure_df = adventure_df.loc[:, ~adventure_df.columns.duplicated()]

# 1ï¸âƒ£ ë‚ ì§œ/ìˆ«ìí˜• ë³€í™˜
adventure_df["OrderDate"] = pd.to_datetime(
    adventure_df["OrderDate"], errors="coerce"
)

adventure_df["SalesAmount"] = pd.to_numeric(
    adventure_df["SalesAmount"], errors="coerce"
)

adventure_df["OrderQuantity"] = pd.to_numeric(
    adventure_df["OrderQuantity"], errors="coerce"
).astype("Int64")   # ì •ìˆ˜ + ê²°ì¸¡ í—ˆìš©

# 2ï¸âƒ£ ì—°-ì›” ì»¬ëŸ¼
adventure_df["YearMonth"] = adventure_df["OrderDate"].dt.to_period("M").astype(str)

display(adventure_df[["OrderDate", "YearMonth", "SalesAmount"]].head())

# [5-1] ì›”ë³„ ë§¤ì¶œ ì¶”ì´

monthly_sales = (
    adventure_df.groupby("YearMonth")["SalesAmount"]
                .sum()
                .reset_index()
)

plt.figure(figsize=(12,5))
sns.lineplot(data=monthly_sales, x="YearMonth", y="SalesAmount", marker="o")
plt.xticks(rotation=45)
plt.title("ì›”ë³„ ë§¤ì¶œ ì¶”ì´")
plt.xlabel("ì›”")
plt.ylabel("ë§¤ì¶œì•¡")
plt.tight_layout()
plt.show()

# [5-2] ê³ ê°ë³„ ì´ ë§¤ì¶œ Top 10

customer_sales = (
    adventure_df.groupby("Customer")["SalesAmount"]
                .sum()
                .sort_values(ascending=False)
                .head(10)
                .reset_index()
)

plt.figure(figsize=(10,5))
sns.barplot(data=customer_sales, x="Customer", y="SalesAmount")
plt.xticks(rotation=45, ha="right")
plt.title("ê³ ê°ë³„ ì´ ë§¤ì¶œ Top 10")
plt.xlabel("ê³ ê°")
plt.ylabel("ì´ ë§¤ì¶œì•¡")
plt.tight_layout()
plt.show()

# [5-3] ì±„ë„(Channel)ë³„ ë§¤ì¶œ

channel_sales = (
    adventure_df.groupby("Channel")["SalesAmount"]
                .sum()
                .reset_index()
)

plt.figure(figsize=(8,5))
sns.barplot(data=channel_sales, x="Channel", y="SalesAmount")
plt.title("íŒë§¤ ì±„ë„ë³„ ë§¤ì¶œ")
plt.xlabel("ì±„ë„")
plt.ylabel("ì´ ë§¤ì¶œì•¡")
plt.tight_layout()
plt.show()

display(channel_sales)

# [6-1] RFMìš© ë°ì´í„° ì¤€ë¹„

rfm_df = adventure_df.copy()
rfm_df["OrderDate"] = pd.to_datetime(rfm_df["OrderDate"])

# ê¸°ì¤€ ë‚ ì§œ: ë§ˆì§€ë§‰ ì£¼ë¬¸ì¼ + 1ì¼
snapshot_date = rfm_df["OrderDate"].max() + pd.Timedelta(days=1)
print("ğŸ“Œ ê¸°ì¤€ ë‚ ì§œ(snapshot_date):", snapshot_date)

# [6-2] ê³ ê°ë³„ R, F, M ê³„ì‚°

rfm = rfm_df.groupby("Customer").agg(
    Recency=("OrderDate", lambda x: (snapshot_date - x.max()).days),  # ë§ˆì§€ë§‰ ì£¼ë¬¸ìœ¼ë¡œë¶€í„° ë©°ì¹  ì§€ë‚¬ëŠ”ì§€
    Frequency=("SalesOrderID", "nunique"),                            # ì£¼ë¬¸ ê±´ìˆ˜
    Monetary=("SalesAmount", "sum")                                   # ì´ ë§¤ì¶œì•¡
)

display(rfm.head())

# [6-3] ì ìˆ˜í™” (1~5ì ) - ë¶„ìœ„ìˆ˜ ê¸°ë°˜
# qcut ì¤‘ë³µ ë¬¸ì œ ë°©ì§€ ìœ„í•´ rank ì‚¬ìš©

# Recency: ì‘ì„ìˆ˜ë¡ ì¢‹ì€ ê³ ê° â†’ ì ìˆ˜ í´ìˆ˜ë¡ ì¢‹ê²Œ ë¼ë²¨
rfm["R_score"] = pd.qcut(
    rfm["Recency"].rank(method="first"),
    5,
    labels=[5,4,3,2,1]  # 5ì : ê°€ì¥ ìµœê·¼ì— êµ¬ë§¤
)

# Frequency, Monetary: í´ìˆ˜ë¡ ì¢‹ì€ ê³ ê°
rfm["F_score"] = pd.qcut(
    rfm["Frequency"].rank(method="first"),
    5,
    labels=[1,2,3,4,5]
)

rfm["M_score"] = pd.qcut(
    rfm["Monetary"].rank(method="first"),
    5,
    labels=[1,2,3,4,5]
)

display(rfm.head())

# [6-4] í†µí•© ê³ ê°ìƒì• ê°€ì¹˜ ì ìˆ˜ (CLV_score)

rfm["CLV_score"] = (
    rfm["R_score"].astype(int) * 0.4 +
    rfm["F_score"].astype(int) * 0.3 +
    rfm["M_score"].astype(int) * 0.3
)

rfm["CLV_score"].describe()

# [7-1] ì„¸ê·¸ë¨¼íŠ¸ ë¼ë²¨ í•¨ìˆ˜

def label_segment(score: float) -> str:
    if score >= 4.0:
        return "í•µì‹¬ ìš°ëŸ‰ ê³ ê°"
    elif score >= 3.0:
        return "ì„±ì¥ ê³ ê°"
    elif score >= 2.0:
        return "ì¼ë°˜/ì ì¬ ê³ ê°"
    else:
        return "ì´íƒˆ ìœ„í—˜ ê³ ê°"

rfm["segment"] = rfm["CLV_score"].apply(label_segment)

rfm["segment"].value_counts()

# [7-2] ì„¸ê·¸ë¨¼íŠ¸ë³„ ìš”ì•½ (ê³ ê°ìˆ˜, í‰ê·  ì ìˆ˜, ì´ ë§¤ì¶œ)

segment_summary = (
    rfm.groupby("segment")
       .agg(
           ê³ ê°ìˆ˜=("CLV_score", "count"),
           í‰ê· ì ìˆ˜=("CLV_score", "mean"),
           ì´ë§¤ì¶œ=("Monetary", "sum")
       )
       .reset_index()
)

display(segment_summary)

# [7-3] ì„¸ê·¸ë¨¼íŠ¸ë³„ ì´ ë§¤ì¶œ ì‹œê°í™”

plt.figure(figsize=(8,5))
sns.barplot(data=segment_summary, x="segment", y="ì´ë§¤ì¶œ")
plt.title("ê³ ê° ì„¸ê·¸ë¨¼íŠ¸ë³„ ì´ ë§¤ì¶œ")
plt.xlabel("ì„¸ê·¸ë¨¼íŠ¸")
plt.ylabel("ì´ ë§¤ì¶œ")
plt.xticks(rotation=15)
plt.tight_layout()
plt.show()

import plotly.express as px

country_sales = (
    adventure_df.groupby("CountryRegion")["SalesAmount"]
                .sum()
                .reset_index()
)

fig = px.choropleth(
    country_sales,
    locations="CountryRegion",      # êµ­ê°€ ì´ë¦„ ì»¬ëŸ¼
    locationmode="country names",   # êµ­ê°€ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘
    color="SalesAmount",
    title="êµ­ê°€ë³„ ë§¤ì¶œ"
)
fig.show()

monthly_sales = (
    adventure_df.groupby("YearMonth")["SalesAmount"]
                .sum()
                .reset_index()
)

plt.figure(figsize=(12,5))
sns.barplot(data=monthly_sales, x="YearMonth", y="SalesAmount")
plt.xticks(rotation=45)
plt.title("ì›”ë³„ ë§¤ì¶œ ì¶”ì´")
plt.xlabel("ì›”")
plt.ylabel("ë§¤ì¶œì•¡")
plt.tight_layout()
plt.show()

segment_sales = (
    adventure_df.groupby(["ProductKey", "Channel"])["SalesAmount"]
                .sum()
                .reset_index()
)

fig = px.bar(
    segment_sales,
    x="ProductKey",
    y="SalesAmount",
    color="Channel",
    title="ì œí’ˆ + ì±„ë„ë³„ ë§¤ì¶œ (ìŠ¤íƒ ë§‰ëŒ€)",
    barmode="stack"
)
fig.show()

